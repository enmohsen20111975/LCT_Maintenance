{% extends "base.html" %}

{% block title %}Comprehensive Work Orders Analysis - AllCM Table{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet" />
<style>
    .analysis-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }
    
    .metric-card.primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .metric-card.success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
    .metric-card.warning { background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); }
    .metric-card.danger { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); }
    .metric-card.info { background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%); }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .metric-label {
        font-size: 1rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        height: 450px;
        border: 1px solid #e9ecef;
    }
    
    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
        text-align: center;
        border-bottom: 2px solid #f8f9fa;
        padding-bottom: 0.5rem;
    }
    
    .advanced-filter-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 2px solid #e9ecef;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .filter-row {
        margin-bottom: 1.5rem;
    }
    
    .filter-row:last-child {
        margin-bottom: 0;
    }
    
    .data-table-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        max-height: 700px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
    }
    
    .status-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 25px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-exe { background-color: #ffc107; color: #212529; }
    .status-ini { background-color: #17a2b8; color: white; }
    .status-ter { background-color: #28a745; color: white; }
    .status-prt { background-color: #fd7e14; color: white; }
    .status-apc { background-color: #dc3545; color: white; }
    
    .job-type-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .type-c { background-color: #dc3545; color: white; }
    .type-p { background-color: #28a745; color: white; }
    .type-i { background-color: #17a2b8; color: white; }
    .type-o { background-color: #6c757d; color: white; }
    .type-u { background-color: #fd7e14; color: white; }
    .type-b { background-color: #6f42c1; color: white; }
    .type-l { background-color: #20c997; color: white; }
    
    .priority-badge {
        padding: 0.3rem 0.6rem;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: 600;
    }
    
    .priority-immediate { background-color: #dc3545; color: white; }
    .priority-high { background-color: #fd7e14; color: white; }
    .priority-medium { background-color: #ffc107; color: #212529; }
    .priority-low { background-color: #28a745; color: white; }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-content {
        background: white;
        padding: 3rem;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .select2-container {
        width: 100% !important;
    }
    
    .btn-action {
        margin: 0.25rem;
        border-radius: 25px;
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .category-analysis {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .insights-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        border-left: 5px solid #667eea;
    }
    
    .insight-item {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .insight-warning { border-left-color: #ffc107; }
    .insight-danger { border-left-color: #dc3545; }
    .insight-success { border-left-color: #28a745; }
    .insight-info { border-left-color: #17a2b8; }
    
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table td {
        vertical-align: middle;
        border-color: #f8f9fa;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateX(2px);
        transition: all 0.2s ease;
    }
    
    .export-options {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .filter-toggle {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0.8rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .filter-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1rem;
    }
    
    .breadcrumb-item + .breadcrumb-item::before {
        content: ">";
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Work Orders Analysis</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">
                <i class="bi bi-graph-up-arrow text-primary"></i>
                Comprehensive Work Orders Analysis
            </h1>
            <p class="text-muted mb-0">Complete analysis of AllCM table with advanced filtering and insights</p>
        </div>
        <div class="export-options">
            <button class="btn btn-outline-success btn-action" onclick="exportData('excel')">
                <i class="bi bi-file-earmark-excel"></i> Export Excel
            </button>
            <button class="btn btn-outline-info btn-action" onclick="exportData('csv')">
                <i class="bi bi-file-earmark-text"></i> Export CSV
            </button>
            <button class="btn btn-primary btn-action" onclick="refreshAnalysis()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>

    <!-- Advanced Filter Component -->
    {% include 'components/advanced_work_order_filters.html' %}

    <!-- Template-specific integration script -->
    <script>
    // Integration for comprehensive_work_orders_analysis.html
    function applyMainFilters(filters) {
        console.log('Applying filters for comprehensive work orders analysis:', filters);
        
        // Update current filters
        currentFilters = filters;
        
        // Call existing filter application
        if (typeof loadFilteredData === 'function') {
            return loadFilteredData();
        } else if (typeof applyFilters === 'function') {
            return applyFilters();
        }
        
        return Promise.resolve();
    }
    </script>

    <!-- Advanced Filters -->
    <div class="collapse" id="advancedFilters">
        <div class="advanced-filter-section">
            <h5 class="mb-4">
                <i class="bi bi-funnel-fill text-primary"></i> Advanced Filtering Options
            </h5>
            <form id="filterForm">
                <!-- Row 1: Status and Job Details -->
                <div class="row filter-row">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Work Order Status (ETATJOB)</label>
                        <select class="form-select select2" id="etatjobFilter" name="etatjob" multiple>
                            <option value="">All Statuses</option>
                        </select>
                        <small class="text-muted">Select one or more statuses</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Work Supplier</label>
                        <select class="form-select select2" id="supplierFilter" name="work_supplier_key" multiple>
                            <option value="">All Suppliers</option>
                        </select>
                        <small class="text-muted">Select suppliers to filter</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Job Type</label>
                        <select class="form-select select2" id="jobTypeFilter" name="job_type" multiple>
                            <option value="">All Types</option>
                        </select>
                        <small class="text-muted">Maintenance type categories</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Priority Level</label>
                        <select class="form-select select2" id="priorityFilter" name="priority" multiple>
                            <option value="">All Priorities</option>
                        </select>
                        <small class="text-muted">Priority levels</small>
                    </div>
                </div>
                
                <!-- Row 2: Categories and Organization -->
                <div class="row filter-row">
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">POS Key</label>
                        <select class="form-select select2" id="posKeyFilter" name="pos_key" multiple>
                            <option value="">All POS</option>
                        </select>
                        <small class="text-muted">Position/Location keys</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Cost Purpose</label>
                        <select class="form-select select2" id="costPurposeFilter" name="cost_purpose_key" multiple>
                            <option value="">All Purposes</option>
                        </select>
                        <small class="text-muted">Cost classification</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Inspector</label>
                        <select class="form-select select2" id="inspectorFilter" name="inspector" multiple>
                            <option value="">All Inspectors</option>
                        </select>
                        <small class="text-muted">Assigned inspectors</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Equipment</label>
                        <select class="form-select select2" id="equipmentFilter" name="equipment" multiple>
                            <option value="">All Equipment</option>
                        </select>
                        <small class="text-muted">Equipment/Asset IDs</small>
                    </div>
                </div>
                
                <!-- Row 3: Date Filters and Search -->
                <div class="row filter-row">
                    <div class="col-lg-2 col-md-4">
                        <label class="form-label fw-bold">Date Type</label>
                        <select class="form-select" id="dateType" name="dateType">
                            <option value="order_date">Order Date</option>
                            <option value="execution_date">Execution Date</option>
                            <option value="created_date">Created Date</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-4">
                        <label class="form-label fw-bold">Date From</label>
                        <input type="date" class="form-control" id="dateFrom" name="startDate">
                    </div>
                    <div class="col-lg-2 col-md-4">
                        <label class="form-label fw-bold">Date To</label>
                        <input type="date" class="form-control" id="dateTo" name="endDate">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Search Term</label>
                        <input type="text" class="form-control" id="searchTerm" name="search" placeholder="Search in description, equipment, WO number...">
                        <small class="text-muted">Search across multiple fields</small>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label class="form-label fw-bold">Record Limit</label>
                        <select class="form-select" id="recordLimit" name="limit">
                            <option value="500">500 records</option>
                            <option value="1000" selected>1,000 records</option>
                            <option value="2000">2,000 records</option>
                            <option value="5000">5,000 records</option>
                            <option value="">All records</option>
                        </select>
                    </div>
                </div>
                
                <!-- Filter Actions -->
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="button" class="btn btn-primary btn-action" onclick="applyFilters()">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-secondary btn-action" onclick="clearFilters()">
                            <i class="bi bi-x-circle"></i> Clear All
                        </button>
                        <button type="button" class="btn btn-info btn-action" onclick="saveFilterPreset()">
                            <i class="bi bi-bookmark"></i> Save Preset
                        </button>
                        <button type="button" class="btn btn-outline-info btn-action" onclick="loadFilterPreset()">
                            <i class="bi bi-bookmark-check"></i> Load Preset
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Key Metrics Dashboard -->
    <div class="stats-grid" id="keyMetrics">
        <!-- Metrics will be populated here -->
    </div>

    <!-- Insights Section -->
    <div class="insights-container" id="insightsSection" style="display: none;">
        <h5 class="mb-3">
            <i class="bi bi-lightbulb text-warning"></i> Maintenance Insights & Recommendations
        </h5>
        <div id="insightsList">
            <!-- Insights will be populated here -->
        </div>
    </div>

    <!-- Category Analysis Charts -->
    <div class="category-analysis" id="categoryCharts">
        <!-- Category charts will be populated here -->
    </div>

    <!-- Performance Analysis Charts -->
    <div class="category-analysis" id="performanceCharts">
        <!-- Performance charts will be populated here -->
    </div>

    <!-- AI Fault Analysis Section -->
    <div class="ai-analysis-container mt-4" id="aiAnalysisSection" style="display: none;">
        <div class="card">
            <div class="card-header bg-gradient-info text-white">
                <h5 class="mb-0">
                    <i class="bi bi-robot"></i> AI Fault Analysis & Predictions
                    <span class="badge bg-light text-dark ms-2">BETA</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- Equipment Selection -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Select Equipment for AI Analysis</label>
                        <select class="form-select" id="aiEquipmentSelect">
                            <option value="">Loading equipment...</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-info me-2" onclick="loadAIAnalysis()">
                            <i class="bi bi-cpu"></i> Analyze Equipment
                        </button>
                        <button class="btn btn-outline-info" onclick="loadComprehensiveAI()">
                            <i class="bi bi-globe"></i> Global Analysis
                        </button>
                    </div>
                </div>

                <!-- AI Analysis Results -->
                <div id="aiAnalysisResults" style="display: none;">
                    <!-- Fault Patterns -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary"><i class="bi bi-graph-up"></i> Fault Patterns & Trends</h6>
                            <div id="faultPatternsContainer" class="row">
                                <!-- Fault patterns will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- AI Insights -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-success"><i class="bi bi-lightbulb"></i> AI-Generated Insights</h6>
                            <div id="aiInsightsContainer">
                                <!-- AI insights will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- Fault Timeline Chart -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-warning"><i class="bi bi-clock-history"></i> Fault Timeline Analysis</h6>
                            <canvas id="faultTimelineChart" height="400"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Global AI Results -->
                <div id="globalAIResults" style="display: none;">
                    <div class="row">
                        <!-- Critical Equipment -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> Critical Equipment</h6>
                            <div id="criticalEquipmentList" class="list-group">
                                <!-- Critical equipment will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Common Fault Types -->
                        <div class="col-md-6 mb-3">
                            <h6 class="text-info"><i class="bi bi-bar-chart"></i> Most Common Faults</h6>
                            <canvas id="commonFaultsChart" height="300"></canvas>
                        </div>
                    </div>
                    
                    <!-- Global Recommendations -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="text-success"><i class="bi bi-check-circle"></i> Global Recommendations</h6>
                            <div id="globalRecommendations" class="alert alert-info">
                                <!-- Global recommendations will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="data-table-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> Work Orders Data
                <span class="badge bg-primary ms-2" id="recordCount">0 records</span>
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="toggleFullscreen()">
                    <i class="bi bi-fullscreen"></i> Fullscreen
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="exportTableData()">
                    <i class="bi bi-download"></i> Export Table
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="workOrdersTable">
                <thead>
                    <tr>
                        <th>WO Number</th>
                        <th>Status</th>
                        <th>Job Type</th>
                        <th>Priority</th>
                        <th>Equipment</th>
                        <th>Supplier</th>
                        <th>Cost Purpose</th>
                        <th>Inspector</th>
                        <th>Order Date</th>
                        <th>Duration (hrs)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <nav aria-label="Table pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="tablePagination">
                <!-- Pagination will be populated here -->
            </ul>
        </nav>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5>Loading Work Orders Analysis...</h5>
        <p class="text-muted">Processing AllCM table data with advanced analytics</p>
        <div class="progress mt-3" style="width: 300px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 75%"></div>
        </div>
    </div>
</div>

<!-- Work Order Detail Modal -->
<div class="modal fade" id="workOrderModal" tabindex="-1" aria-labelledby="workOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="workOrderModalLabel">Work Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="workOrderDetails">
                <!-- Work order details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printWorkOrder()">Print</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

<script>
let currentData = [];
let currentFilters = {};
let charts = {};
let currentPage = 1;
let recordsPerPage = 50;
let totalRecords = 0;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializeComponents();
    loadInitialData();
});

// Initialize all components
function initializeComponents() {
    // Initialize Select2 components
    $('.select2').select2({
        placeholder: 'Select options...',
        allowClear: true
    });
    
    // Set default date range (last 30 days)
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    
    document.getElementById('dateFrom').value = startDate.toISOString().split('T')[0];
    document.getElementById('dateTo').value = endDate.toISOString().split('T')[0];
    
    // Initialize filter options
    initializeFilters();
}

// Initialize filter dropdowns
async function initializeFilters() {
    console.log('🔍 Initializing filters...');
    showLoading(true);
    try {
        console.log('📡 Fetching filter options from API...');
        const response = await fetch('/api/work-orders/filter-options');
        console.log('📊 Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const options = await response.json();
        console.log('✅ Filter options received:', options);
        
        if (options.success) {
            console.log('🎯 Populating filter dropdowns...');
            populateFilterDropdowns(options.data);
            console.log('✅ Filter dropdowns populated successfully!');
        } else {
            console.error('❌ API returned error:', options.error);
            showError('Failed to load filter options: ' + (options.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('❌ Error loading filter options:', error);
        showError('Failed to load filter options: ' + error.message);
    } finally {
        showLoading(false);
    }
}

// Populate filter dropdowns with data
function populateFilterDropdowns(options) {
    // Status (ETATJOB) options
    const etatjobSelect = document.getElementById('etatjobFilter');
    etatjobSelect.innerHTML = '<option value="">All Statuses</option>';
    options.etatjob?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        etatjobSelect.add(optionElement);
    });
    
    // Work Supplier options
    const supplierSelect = document.getElementById('supplierFilter');
    supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
    options.work_supplier_key?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        supplierSelect.add(optionElement);
    });
    
    // Job Type options
    const jobTypeSelect = document.getElementById('jobTypeFilter');
    jobTypeSelect.innerHTML = '<option value="">All Types</option>';
    options.job_type?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        jobTypeSelect.add(optionElement);
    });
    
    // Priority options
    const prioritySelect = document.getElementById('priorityFilter');
    prioritySelect.innerHTML = '<option value="">All Priorities</option>';
    options.priority?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        prioritySelect.add(optionElement);
    });
    
    // POS Key options
    const posKeySelect = document.getElementById('posKeyFilter');
    posKeySelect.innerHTML = '<option value="">All POS</option>';
    options.pos_key?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        posKeySelect.add(optionElement);
    });
    
    // Cost Purpose options
    const costPurposeSelect = document.getElementById('costPurposeFilter');
    costPurposeSelect.innerHTML = '<option value="">All Purposes</option>';
    options.cost_purpose_key?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        costPurposeSelect.add(optionElement);
    });
    
    // Inspector options
    const inspectorSelect = document.getElementById('inspectorFilter');
    inspectorSelect.innerHTML = '<option value="">All Inspectors</option>';
    options.inspector?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        inspectorSelect.add(optionElement);
    });
    
    // Equipment options
    const equipmentSelect = document.getElementById('equipmentFilter');
    equipmentSelect.innerHTML = '<option value="">All Equipment</option>';
    options.equipment?.forEach(option => {
        const optionElement = new Option(option.label, option.value);
        equipmentSelect.add(optionElement);
    });
    
    // Refresh Select2 components
    $('.select2').trigger('change');
}

// Load initial data
async function loadInitialData() {
    showLoading(true);
    try {
        const [analysisResponse, dataResponse] = await Promise.all([
            fetch('/api/work-orders/comprehensive-analysis'),
            fetch('/api/work-orders/search')
        ]);
        
        const analysisData = await analysisResponse.json();
        const workOrdersData = await dataResponse.json();
        
        if (analysisData.success) {
            displayAnalysis(analysisData.data);
        }
        
        if (workOrdersData.success) {
            currentData = workOrdersData.data;
            totalRecords = currentData.length;
            displayWorkOrders(currentData);
            updatePagination();
        }
        
        // Load AI equipment list
        await loadAIEquipmentList();
        
        // Show AI analysis section
        document.getElementById('aiAnalysisSection').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showError('Failed to load data. Please refresh the page.');
    } finally {
        showLoading(false);
    }
}

// Display comprehensive analysis data
function displayAnalysis(data) {
    displayKeyMetrics(data.basic_stats, data.performance);
    displayCategoryCharts(data.categories || data);
    displayPerformanceCharts(data.performance, data.temporal);
    displayInsights(data.insights);
}

// Display key metrics cards
function displayKeyMetrics(stats, performance) {
    const metricsContainer = document.getElementById('keyMetrics');
    
    const metrics = [
        {
            value: (stats?.total_records || 0).toLocaleString(),
            label: 'Total Work Orders',
            class: 'primary',
            icon: 'bi-clipboard-data'
        },
        {
            value: (stats?.completed_percentage || 0) + '%',
            label: 'Completion Rate',
            class: stats?.completed_percentage > 80 ? 'success' : stats?.completed_percentage > 60 ? 'warning' : 'danger',
            icon: 'bi-check-circle'
        },
        {
            value: performance?.corrective_preventive_ratio || '0:1',
            label: 'C:P Ratio',
            class: 'info',
            icon: 'bi-gear'
        },
        {
            value: (performance?.urgent_percentage || 0) + '%',
            label: 'Urgent Orders',
            class: performance?.urgent_percentage > 30 ? 'danger' : performance?.urgent_percentage > 15 ? 'warning' : 'success',
            icon: 'bi-exclamation-triangle'
        },
        {
            value: (performance?.avg_completion_time || 0) + 'h',
            label: 'Avg Resolution',
            class: 'info',
            icon: 'bi-clock'
        },
        {
            value: Object.keys(stats?.status_distribution || {}).length,
            label: 'Status Types',
            class: 'primary',
            icon: 'bi-list-check'
        }
    ];
    
    metricsContainer.innerHTML = metrics.map(metric => `
        <div class="metric-card ${metric.class}" onclick="focusOnMetric('${metric.label}')">
            <div class="metric-value">
                <i class="${metric.icon} me-2"></i>
                ${metric.value}
            </div>
            <div class="metric-label">${metric.label}</div>
        </div>
    `).join('');
}

// Display category analysis charts
function displayCategoryCharts(categories) {
    const chartsContainer = document.getElementById('categoryCharts');
    chartsContainer.innerHTML = '';
    
    const chartConfigs = [
        { key: 'etatjob', title: 'Work Order Status Distribution', type: 'doughnut', colors: 'status' },
        { key: 'work_suppliers', title: 'Work Suppliers Distribution', type: 'bar', colors: 'suppliers' },
        { key: 'job_types', title: 'Job Types Distribution', type: 'pie', colors: 'jobTypes' },
        { key: 'cost_purposes', title: 'Cost Purposes Distribution', type: 'bar', colors: 'costs' },
        { key: 'inspectors', title: 'Inspectors Distribution', type: 'doughnut', colors: 'inspectors' },
        { key: 'pos_keys', title: 'POS Keys Distribution', type: 'pie', colors: 'positions' }
    ];
    
    chartConfigs.forEach(config => {
        if (categories[config.key] && categories[config.key].length > 0) {
            createCategoryChart(config, categories[config.key]);
        }
    });
}

// Display performance charts
function displayPerformanceCharts(performance, temporal) {
    const chartsContainer = document.getElementById('performanceCharts');
    
    // Create performance analysis charts
    if (performance) {
        createPerformanceChart('Equipment Downtime Analysis', performance.equipment_downtime);
    }
    
    if (temporal) {
        createTemporalChart('Work Orders Timeline', temporal.monthly);
    }
}

// Create individual category chart
function createCategoryChart(config, data) {
    const chartId = `chart_${config.key}`;
    const chartContainer = document.createElement('div');
    chartContainer.className = 'chart-container';
    chartContainer.innerHTML = `
        <div class="chart-title">
            <i class="bi bi-bar-chart text-primary me-2"></i>
            ${config.title}
        </div>
        <canvas id="${chartId}"></canvas>
    `;
    
    document.getElementById('categoryCharts').appendChild(chartContainer);
    
    const ctx = document.getElementById(chartId).getContext('2d');
    
    // Prepare chart data
    const labels = data.map(item => item.name || item.supplier_name || item.inspector_name || item.code || 'Unknown');
    const values = data.map(item => item.count);
    const colors = generateColors(data.length, config.colors);
    
    const chartConfig = {
        type: config.type,
        data: {
            labels: labels,
            datasets: [{
                label: 'Count',
                data: values,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace(/0\.\d+/, '1')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: config.type === 'bar' ? 'top' : 'right',
                    labels: {
                        boxWidth: 12,
                        font: { size: 11 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        afterLabel: function(context) {
                            const item = data[context.dataIndex];
                            return item.percentage ? `Percentage: ${item.percentage}%` : '';
                        }
                    }
                }
            },
            scales: config.type === 'bar' ? {
                y: { 
                    beginAtZero: true,
                    ticks: { font: { size: 10 } }
                },
                x: {
                    ticks: { 
                        font: { size: 10 },
                        maxRotation: 45
                    }
                }
            } : {},
            onClick: function(evt, elements) {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const item = data[index];
                    filterByCategory(config.key, item.code || item.name);
                }
            }
        }
    };
    
    charts[chartId] = new Chart(ctx, chartConfig);
}

// Generate color palettes for different chart types
function generateColors(count, type) {
    const colorPalettes = {
        status: ['#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1'],
        suppliers: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
        jobTypes: ['#dc3545', '#28a745', '#17a2b8', '#6c757d', '#fd7e14', '#6f42c1', '#20c997'],
        costs: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7b731', '#5f27cd', '#00d2d3'],
        inspectors: ['#3742fa', '#2f3542', '#ff3838', '#ff6348', '#7bed9f'],
        positions: ['#70a1ff', '#5352ed', '#ff4757', '#ff6348', '#2ed573'],
        default: [
            'rgba(102, 126, 234, 0.8)',
            'rgba(118, 75, 162, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)', 
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
        ]
    };
    
    const palette = colorPalettes[type] || colorPalettes.default;
    const colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(palette[i % palette.length]);
    }
    return colors;
}

// Display insights and recommendations
function displayInsights(insights) {
    if (!insights || insights.length === 0) {
        document.getElementById('insightsSection').style.display = 'none';
        return;
    }
    
    document.getElementById('insightsSection').style.display = 'block';
    
    const insightsList = document.getElementById('insightsList');
    insightsList.innerHTML = insights.map(insight => `
        <div class="insight-item insight-${insight.type}">
            <div class="d-flex align-items-start">
                <div class="me-3">
                    <i class="bi bi-${getInsightIcon(insight.type)} fs-4 text-${insight.type === 'warning' ? 'warning' : insight.type === 'danger' ? 'danger' : insight.type === 'success' ? 'success' : 'info'}"></i>
                </div>
                <div class="flex-grow-1">
                    <h6 class="fw-bold mb-2">${insight.title}</h6>
                    <p class="mb-2">${insight.message}</p>
                    ${insight.recommendation ? `<small class="text-muted"><strong>Recommendation:</strong> ${insight.recommendation}</small>` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

// Get appropriate icon for insight type
function getInsightIcon(type) {
    const icons = {
        warning: 'exclamation-triangle',
        danger: 'x-circle',
        success: 'check-circle',
        info: 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Apply filters and search
async function applyFilters() {
    const formData = new FormData(document.getElementById('filterForm'));
    const filters = {};
    
    // Process form data
    for (const [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
            filters[key] = value;
        }
    }
    
    // Handle multiple selections for Select2 fields
    $('.select2').each(function() {
        const fieldName = this.name;
        const selectedValues = $(this).val();
        if (selectedValues && selectedValues.length > 0 && selectedValues[0] !== '') {
            filters[fieldName] = selectedValues;
        }
    });
    
    currentFilters = filters;
    currentPage = 1; // Reset to first page
    
    showLoading(true);
    try {
        const response = await fetch('/api/work-orders/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filters)
        });
        
        const data = await response.json();
        if (data.success) {
            currentData = data.data;
            totalRecords = currentData.length;
            displayWorkOrders(currentData);
            updatePagination();
            
            // Update analysis with filtered data
            updateAnalysisWithFilteredData();
        } else {
            showError(data.error || 'Failed to apply filters');
        }
    } catch (error) {
        console.error('Error applying filters:', error);
        showError('Error applying filters');
    } finally {
        showLoading(false);
    }
}

// Clear all filters
function clearFilters() {
    document.getElementById('filterForm').reset();
    $('.select2').val(null).trigger('change');
    currentFilters = {};
    currentPage = 1;
    loadInitialData();
}

// Display work orders in table with pagination
function displayWorkOrders(workOrders) {
    const tableBody = document.querySelector('#workOrdersTable tbody');
    const recordCount = document.getElementById('recordCount');
    
    // Calculate pagination
    const startIndex = (currentPage - 1) * recordsPerPage;
    const endIndex = startIndex + recordsPerPage;
    const paginatedData = workOrders.slice(startIndex, endIndex);
    
    recordCount.textContent = `${workOrders.length.toLocaleString()} records`;
    
    if (paginatedData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="11" class="text-center py-4">No work orders found matching your criteria</td></tr>';
        return;
    }
    
    tableBody.innerHTML = paginatedData.map(wo => `
        <tr>
            <td><strong>${wo.wo_number || wo.wo_name || 'N/A'}</strong></td>
            <td>${formatStatus(wo.etatjob)}</td>
            <td>${formatJobType(wo.job_type)}</td>
            <td>${formatPriority(wo.priority_key)}</td>
            <td><code>${wo.calculated_equipment || wo.equipement || 'N/A'}</code></td>
            <td><small>${wo.work_supplier_key || 'N/A'}</small></td>
            <td><small>${wo.cost_purpose_key || 'N/A'}</small></td>
            <td><small>${wo.inspector || 'N/A'}</small></td>
            <td>${formatDate(wo.order_date)}</td>
            <td>${formatDuration(wo.duration_hours)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewWorkOrderDetails('${wo.wo_number || wo.wo_name}')">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

// Format status badge
function formatStatus(status) {
    if (!status) return '<span class="badge bg-secondary">N/A</span>';
    const statusClass = `status-${status.toLowerCase()}`;
    return `<span class="status-badge ${statusClass}">${status}</span>`;
}

// Format job type badge
function formatJobType(jobType) {
    if (!jobType) return '<span class="badge bg-secondary">N/A</span>';
    const typeClass = `type-${jobType.toLowerCase()}`;
    const typeNames = {
        'C': 'Corrective',
        'P': 'Preventive',
        'I': 'Inspection',
        'O': 'Operational',
        'U': 'Urgent',
        'B': 'Breakdown',
        'L': 'Lubrication'
    };
    return `<span class="job-type-badge ${typeClass}">${typeNames[jobType] || jobType}</span>`;
}

// Format priority badge
function formatPriority(priority) {
    if (!priority) return '<span class="badge bg-secondary">N/A</span>';
    
    let priorityClass = 'priority-medium';
    if (priority.includes('IMM') || priority.includes('1-')) {
        priorityClass = 'priority-immediate';
    } else if (priority.includes('HIGH') || priority.includes('2-')) {
        priorityClass = 'priority-high';
    } else if (priority.includes('LOW') || priority.includes('4-')) {
        priorityClass = 'priority-low';
    }
    
    return `<span class="priority-badge ${priorityClass}">${priority}</span>`;
}

// Format date
function formatDate(date) {
    if (!date) return 'N/A';
    try {
        return new Date(date).toLocaleDateString();
    } catch {
        return date;
    }
}

// Format duration
function formatDuration(hours) {
    if (!hours || hours === 0) return 'N/A';
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return `${h}h ${m}m`;
}

// Update pagination
function updatePagination() {
    const totalPages = Math.ceil(totalRecords / recordsPerPage);
    const paginationContainer = document.getElementById('tablePagination');
    
    if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
    }
    
    let paginationHTML = '';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
            </li>
        `;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

// Change page
function changePage(page) {
    if (page < 1 || page > Math.ceil(totalRecords / recordsPerPage)) return;
    currentPage = page;
    displayWorkOrders(currentData);
    updatePagination();
}

// View work order details
function viewWorkOrderDetails(woNumber) {
    // Find the work order in current data
    const workOrder = currentData.find(wo => wo.wo_number === woNumber || wo.wo_name === woNumber);
    
    if (!workOrder) {
        showError('Work order not found');
        return;
    }
    
    // Populate modal with work order details
    const modalBody = document.getElementById('workOrderDetails');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-sm">
                    <tr><td><strong>WO Number:</strong></td><td>${workOrder.wo_number || workOrder.wo_name || 'N/A'}</td></tr>
                    <tr><td><strong>Status:</strong></td><td>${formatStatus(workOrder.etatjob)}</td></tr>
                    <tr><td><strong>Job Type:</strong></td><td>${formatJobType(workOrder.job_type)}</td></tr>
                    <tr><td><strong>Priority:</strong></td><td>${formatPriority(workOrder.priority_key)}</td></tr>
                    <tr><td><strong>Equipment:</strong></td><td>${workOrder.calculated_equipment || workOrder.equipement || 'N/A'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Assignment & Timing</h6>
                <table class="table table-sm">
                    <tr><td><strong>Supplier:</strong></td><td>${workOrder.work_supplier_key || 'N/A'}</td></tr>
                    <tr><td><strong>Inspector:</strong></td><td>${workOrder.inspector || 'N/A'}</td></tr>
                    <tr><td><strong>Order Date:</strong></td><td>${formatDate(workOrder.order_date)}</td></tr>
                    <tr><td><strong>Execution Date:</strong></td><td>${formatDate(workOrder.jobexec_dt)}</td></tr>
                    <tr><td><strong>Duration:</strong></td><td>${formatDuration(workOrder.duration_hours)}</td></tr>
                </table>
            </div>
        </div>
        ${workOrder.description ? `
            <div class="mt-3">
                <h6>Description</h6>
                <p class="border p-2 rounded">${workOrder.description}</p>
            </div>
        ` : ''}
    `;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('workOrderModal'));
    modal.show();
}

// Export data functions
function exportData(format) {
    if (currentData.length === 0) {
        showError('No data to export');
        return;
    }
    
    const params = new URLSearchParams();
    Object.keys(currentFilters).forEach(key => {
        params.append(key, currentFilters[key]);
    });
    
    const url = `/api/work-orders/export?${params.toString()}&format=${format}`;
    window.open(url, '_blank');
}

// Export table data
function exportTableData() {
    if (currentData.length === 0) {
        showError('No data to export');
        return;
    }
    
    // Create CSV content
    const headers = ['WO Number', 'Status', 'Job Type', 'Priority', 'Equipment', 'Supplier', 'Cost Purpose', 'Inspector', 'Order Date', 'Duration (hrs)'];
    const csvContent = [
        headers.join(','),
        ...currentData.map(wo => [
            wo.wo_number || wo.wo_name || '',
            wo.etatjob || '',
            wo.job_type || '',
            wo.priority_key || '',
            wo.calculated_equipment || wo.equipement || '',
            wo.work_supplier_key || '',
            wo.cost_purpose_key || '',
            wo.inspector || '',
            wo.order_date || '',
            wo.duration_hours || ''
        ].join(','))
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `work_orders_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Refresh analysis
function refreshAnalysis() {
    clearFilters();
    loadInitialData();
}

// Show/hide loading overlay
function showLoading(show) {
    document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
}

// Show error message
function showError(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'toast position-fixed top-0 end-0 m-3';
    toast.innerHTML = `
        <div class="toast-header bg-danger text-white">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">${message}</div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Save filter preset
function saveFilterPreset() {
    const presetName = prompt('Enter a name for this filter preset:');
    if (!presetName) return;
    
    const presets = JSON.parse(localStorage.getItem('workOrderFilterPresets') || '{}');
    presets[presetName] = currentFilters;
    localStorage.setItem('workOrderFilterPresets', JSON.stringify(presets));
    
    showSuccess('Filter preset saved successfully!');
}

// Load filter preset
function loadFilterPreset() {
    const presets = JSON.parse(localStorage.getItem('workOrderFilterPresets') || '{}');
    const presetNames = Object.keys(presets);
    
    if (presetNames.length === 0) {
        showError('No saved filter presets found');
        return;
    }
    
    const selectedPreset = prompt(`Select a preset:\n${presetNames.join('\n')}`);
    if (!selectedPreset || !presets[selectedPreset]) return;
    
    // Apply preset filters
    const filters = presets[selectedPreset];
    Object.keys(filters).forEach(key => {
        const element = document.getElementById(key + 'Filter') || document.getElementById(key);
        if (element) {
            if (element.classList.contains('select2')) {
                $(element).val(filters[key]).trigger('change');
            } else {
                element.value = filters[key];
            }
        }
    });
    
    showSuccess('Filter preset loaded successfully!');
}

// Show success message
function showSuccess(message) {
    const toast = document.createElement('div');
    toast.className = 'toast position-fixed top-0 end-0 m-3';
    toast.innerHTML = `
        <div class="toast-header bg-success text-white">
            <i class="bi bi-check-circle me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">${message}</div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

// Toggle fullscreen mode
function toggleFullscreen() {
    const container = document.querySelector('.data-table-container');
    if (!document.fullscreenElement) {
        container.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
}

// Focus on specific metric
function focusOnMetric(metricType) {
    // This could implement specific filtering based on the metric clicked
    console.log('Focusing on metric:', metricType);
}

// Filter by category (when clicking on chart segments)
function filterByCategory(categoryType, categoryValue) {
    const filterMap = {
        'etatjob': 'etatjobFilter',
        'work_suppliers': 'supplierFilter',
        'job_types': 'jobTypeFilter',
        'cost_purposes': 'costPurposeFilter',
        'inspectors': 'inspectorFilter',
        'pos_keys': 'posKeyFilter'
    };
    
    const filterId = filterMap[categoryType];
    if (filterId) {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
            $(filterElement).val([categoryValue]).trigger('change');
            applyFilters();
        }
    }
}

// Update analysis with filtered data
function updateAnalysisWithFilteredData() {
    // Recalculate metrics based on filtered data
    const stats = calculateFilteredStats(currentData);
    displayKeyMetrics(stats.basic, stats.performance);
}

// Calculate statistics from filtered data
function calculateFilteredStats(data) {
    const total = data.length;
    const completed = data.filter(wo => wo.etatjob === 'TER').length;
    const urgent = data.filter(wo => wo.priority_key && (wo.priority_key.includes('IMM') || wo.priority_key.includes('1-'))).length;
    
    return {
        basic: {
            total_records: total,
            completed_percentage: total > 0 ? Math.round((completed / total) * 100) : 0,
            status_distribution: {}
        },
        performance: {
            urgent_percentage: total > 0 ? Math.round((urgent / total) * 100) : 0,
            corrective_preventive_ratio: '1:1',
            avg_completion_time: 24
        }
    };
}

// Print work order
function printWorkOrder() {
    window.print();
}

// AI Analysis Functions
async function loadAIEquipmentList() {
    try {
        console.log('🤖 Loading AI equipment list...');
        const response = await fetch('/api/ai-analysis/equipment-list');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('aiEquipmentSelect');
            select.innerHTML = '<option value="">Select equipment for AI analysis...</option>';
            
            data.equipment.forEach(equipment => {
                const option = new Option(
                    `${equipment.equipment_id} (${equipment.equipment_type}) - ${equipment.fault_count} faults`,
                    equipment.equipment_id
                );
                select.add(option);
            });
            
            console.log(`✅ Loaded ${data.equipment.length} equipment for AI analysis`);
        }
    } catch (error) {
        console.error('❌ Error loading AI equipment list:', error);
        showError('Failed to load equipment list for AI analysis');
    }
}

async function loadAIAnalysis() {
    const equipmentId = document.getElementById('aiEquipmentSelect').value;
    if (!equipmentId) {
        showError('Please select equipment for AI analysis');
        return;
    }
    
    showLoading(true);
    try {
        console.log(`🤖 Analyzing equipment: ${equipmentId}`);
        const response = await fetch(`/api/ai-analysis/equipment/${equipmentId}`);
        const data = await response.json();
        
        if (data.success) {
            displayAIAnalysis(data);
            document.getElementById('aiAnalysisResults').style.display = 'block';
            document.getElementById('globalAIResults').style.display = 'none';
            console.log('✅ AI analysis completed successfully');
        } else {
            showError('AI analysis failed: ' + data.error);
        }
    } catch (error) {
        console.error('❌ Error in AI analysis:', error);
        showError('Failed to perform AI analysis');
    } finally {
        showLoading(false);
    }
}

async function loadComprehensiveAI() {
    showLoading(true);
    try {
        console.log('🌐 Loading comprehensive AI analysis...');
        const response = await fetch('/api/ai-analysis/comprehensive');
        const data = await response.json();
        
        if (data.success) {
            displayGlobalAIAnalysis(data.analysis);
            document.getElementById('globalAIResults').style.display = 'block';
            document.getElementById('aiAnalysisResults').style.display = 'none';
            console.log('✅ Global AI analysis completed');
        } else {
            showError('Global AI analysis failed: ' + data.error);
        }
    } catch (error) {
        console.error('❌ Error in global AI analysis:', error);
        showError('Failed to perform global AI analysis');
    } finally {
        showLoading(false);
    }
}

function displayAIAnalysis(data) {
    // Display fault patterns
    const patternsContainer = document.getElementById('faultPatternsContainer');
    patternsContainer.innerHTML = '';
    
    data.fault_patterns.forEach(pattern => {
        const patternCard = `
            <div class="col-md-6 mb-3">
                <div class="card h-100 border-${getCriticalityColor(pattern.criticality)}">
                    <div class="card-body">
                        <h6 class="card-title text-${getCriticalityColor(pattern.criticality)}">
                            <i class="bi bi-gear"></i> ${pattern.fault_description}
                        </h6>
                        <div class="fault-metrics">
                            <p class="mb-1"><strong>Frequency:</strong> ${pattern.frequency} occurrences</p>
                            <p class="mb-1"><strong>Average Interval:</strong> ${pattern.avg_interval_hours.toFixed(1)} hours</p>
                            <p class="mb-1"><strong>Trend:</strong> 
                                <span class="badge bg-${getTrendColor(pattern.trend)}">${pattern.trend}</span>
                            </p>
                            <p class="mb-0"><strong>Criticality:</strong> 
                                <span class="badge bg-${getCriticalityColor(pattern.criticality)}">${pattern.criticality}</span>
                            </p>
                        </div>
                        ${pattern.related_faults.length > 0 ? 
                            `<small class="text-muted">Related: ${pattern.related_faults.join(', ')}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
        patternsContainer.innerHTML += patternCard;
    });
    
    // Display AI insights
    const insightsContainer = document.getElementById('aiInsightsContainer');
    insightsContainer.innerHTML = '';
    
    data.ai_insights.forEach(insight => {
        const insightCard = `
            <div class="alert alert-${getPriorityColor(insight.priority)} mb-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="alert-heading">${insight.title}</h6>
                        <p class="mb-2">${insight.description}</p>
                        <p class="mb-0"><strong>Recommendation:</strong> ${insight.recommendation}</p>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${getPriorityColor(insight.priority)}">${insight.priority}</span>
                        <br><small class="text-muted">${Math.round(insight.confidence * 100)}% confidence</small>
                    </div>
                </div>
            </div>
        `;
        insightsContainer.innerHTML += insightCard;
    });
    
    // Create fault timeline chart
    createFaultTimelineChart(data);
}

function displayGlobalAIAnalysis(analysis) {
    // Display critical equipment
    const criticalList = document.getElementById('criticalEquipmentList');
    criticalList.innerHTML = '';
    
    analysis.global_patterns.critical_equipment.forEach(equipmentId => {
        const listItem = `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span><i class="bi bi-exclamation-triangle text-danger"></i> ${equipmentId}</span>
                <button class="btn btn-sm btn-outline-info" onclick="selectEquipmentForAI('${equipmentId}')">
                    Analyze
                </button>
            </div>
        `;
        criticalList.innerHTML += listItem;
    });
    
    // Display common faults chart
    createCommonFaultsChart(analysis.global_patterns.most_common_faults);
    
    // Display global recommendations
    const recommendationsContainer = document.getElementById('globalRecommendations');
    recommendationsContainer.innerHTML = '';
    
    if (analysis.recommendations.length > 0) {
        const recommendationsList = analysis.recommendations.map(rec => 
            `<li class="mb-2"><i class="bi bi-check-circle text-success"></i> ${rec}</li>`
        ).join('');
        recommendationsContainer.innerHTML = `<ul class="mb-0">${recommendationsList}</ul>`;
    } else {
        recommendationsContainer.innerHTML = '<p class="mb-0">No specific recommendations at this time. Continue monitoring equipment performance.</p>';
    }
}

function createFaultTimelineChart(data) {
    const ctx = document.getElementById('faultTimelineChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (charts.faultTimeline) {
        charts.faultTimeline.destroy();
    }
    
    // Prepare timeline data
    const datasets = data.fault_patterns.map((pattern, index) => ({
        label: pattern.fault_description,
        data: pattern.time_intervals.map((interval, i) => ({
            x: i + 1,
            y: interval
        })),
        borderColor: getChartColor(index),
        backgroundColor: getChartColor(index, 0.1),
        tension: 0.4
    }));
    
    charts.faultTimeline = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Fault Occurrence Intervals Over Time'
                },
                legend: { position: 'top' }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Occurrence Number' }
                },
                y: {
                    title: { display: true, text: 'Hours Between Faults' }
                }
            }
        }
    });
}

function createCommonFaultsChart(faultData) {
    const ctx = document.getElementById('commonFaultsChart').getContext('2d');
    
    // Destroy existing chart if it exists
    if (charts.commonFaults) {
        charts.commonFaults.destroy();
    }
    
    charts.commonFaults = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: faultData.map(f => f.fault_type),
            datasets: [{
                data: faultData.map(f => f.frequency),
                backgroundColor: faultData.map((_, i) => getChartColor(i))
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Most Common Fault Types'
                }
            }
        }
    });
}

function selectEquipmentForAI(equipmentId) {
    document.getElementById('aiEquipmentSelect').value = equipmentId;
    loadAIAnalysis();
}

function getCriticalityColor(criticality) {
    const colors = { 'high': 'danger', 'medium': 'warning', 'low': 'success' };
    return colors[criticality] || 'secondary';
}

function getTrendColor(trend) {
    const colors = { 'increasing': 'danger', 'stable': 'info', 'decreasing': 'success' };
    return colors[trend] || 'secondary';
}

function getPriorityColor(priority) {
    const colors = { 'critical': 'danger', 'high': 'warning', 'medium': 'info', 'low': 'success' };
    return colors[priority] || 'secondary';
}

function getChartColor(index, alpha = 1) {
    const colors = [
        `rgba(255, 99, 132, ${alpha})`,
        `rgba(54, 162, 235, ${alpha})`,
        `rgba(255, 205, 86, ${alpha})`,
        `rgba(75, 192, 192, ${alpha})`,
        `rgba(153, 102, 255, ${alpha})`,
        `rgba(255, 159, 64, ${alpha})`
    ];
    return colors[index % colors.length];
}

// Print function
function printReport() {
    window.print();
}
</script>
{% endblock %}
