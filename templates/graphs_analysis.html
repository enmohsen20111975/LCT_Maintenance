{% extends "base.html" %}

{% block title %}Charts & Graphs Analysis - LDA{% endblock %}

{% block extra_css %}
<style>
.graphs-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 15px;
}

.chart-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    margin-bottom: 1.5rem;
    min-height: 400px;
}

.chart-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
}

.chart-card .card-header {
    background: linear-gradient(45deg, #f8f9fa, #e9ecef);
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    border-radius: 15px 15px 0 0 !important;
}

.control-panel {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.chart-container {
    height: 350px;
    position: relative;
}

.chart-placeholder {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    color: #6c757d;
    font-size: 1.1rem;
}

.database-selector {
    background: white;
    border: 2px solid #007bff;
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.chart-type-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.chart-type-btn {
    flex: 1;
    min-width: 120px;
    border-radius: 8px;
    padding: 0.5rem 1rem;
    border: 2px solid #dee2e6;
    background: white;
    transition: all 0.2s ease;
}

.chart-type-btn:hover {
    border-color: #007bff;
    background: #f0f8ff;
}

.chart-type-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 2rem;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    display: none;
}

.success-message {
    background: #d1e7dd;
    color: #0f5132;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    display: none;
}

.chart-controls {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.export-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="graphs-header text-center">
        <div class="container">
            <h1 class="display-4 mb-3">
                <i class="bi bi-graph-up me-3"></i>
                Charts & Graphs Analysis
            </h1>
            <p class="lead">Visualize your data with interactive charts and graphs</p>
        </div>
    </div>

    <!-- Database Selection Panel -->
    <div class="database-selector">
        <div class="row align-items-center">
            <div class="col-md-3">
                <label for="databaseSelect" class="form-label fw-bold">
                    <i class="bi bi-database"></i> Select Database:
                </label>
            </div>
            <div class="col-md-6">
                <select id="databaseSelect" class="form-select" onchange="onDatabaseChange()">
                    <option value="">Loading databases...</option>
                </select>
            </div>
            <div class="col-md-3">
                <div id="databaseInfo" class="text-muted small">
                    <i class="bi bi-info-circle"></i> <span id="dbTableCount">0</span> tables
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="row">
            <div class="col-md-4">
                <label for="tableSelect" class="form-label fw-bold">
                    <i class="bi bi-table"></i> Select Table:
                </label>
                <select id="tableSelect" class="form-select" onchange="onTableChange()">
                    <option value="">Choose a table...</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="xAxisSelect" class="form-label fw-bold">
                    <i class="bi bi-arrow-right"></i> X-Axis Column:
                </label>
                <select id="xAxisSelect" class="form-select">
                    <option value="">Choose X-axis...</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="yAxisSelect" class="form-label fw-bold">
                    <i class="bi bi-arrow-up"></i> Y-Axis Column:
                </label>
                <select id="yAxisSelect" class="form-select">
                    <option value="">Choose Y-axis...</option>
                </select>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-12">
                <label class="form-label fw-bold">
                    <i class="bi bi-bar-chart"></i> Chart Type:
                </label>
                <div class="chart-type-selector">
                    <button class="chart-type-btn active" data-type="bar" onclick="selectChartType('bar')">
                        <i class="bi bi-bar-chart"></i> Bar Chart
                    </button>
                    <button class="chart-type-btn" data-type="line" onclick="selectChartType('line')">
                        <i class="bi bi-graph-up"></i> Line Chart
                    </button>
                    <button class="chart-type-btn" data-type="pie" onclick="selectChartType('pie')">
                        <i class="bi bi-pie-chart"></i> Pie Chart
                    </button>
                    <button class="chart-type-btn" data-type="scatter" onclick="selectChartType('scatter')">
                        <i class="bi bi-scatter-plot"></i> Scatter Plot
                    </button>
                    <button class="chart-type-btn" data-type="doughnut" onclick="selectChartType('doughnut')">
                        <i class="bi bi-circle"></i> Doughnut
                    </button>
                    <button class="chart-type-btn" data-type="area" onclick="selectChartType('area')">
                        <i class="bi bi-graph-up-arrow"></i> Area Chart
                    </button>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-8">
                <button id="generateChart" class="btn btn-primary btn-lg" onclick="generateChart()">
                    <i class="bi bi-play-circle"></i> Generate Chart
                </button>
                <button id="refreshData" class="btn btn-outline-secondary" onclick="refreshTableData()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Data
                </button>
            </div>
            <div class="col-md-4 text-end">
                <div class="export-buttons">
                    <button id="exportPNG" class="btn btn-outline-success" onclick="exportChart('png')" disabled>
                        <i class="bi bi-download"></i> PNG
                    </button>
                    <button id="exportJPG" class="btn btn-outline-info" onclick="exportChart('jpg')" disabled>
                        <i class="bi bi-download"></i> JPG
                    </button>
                    <button id="exportPDF" class="btn btn-outline-danger" onclick="exportChart('pdf')" disabled>
                        <i class="bi bi-download"></i> PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <div id="errorMessage" class="error-message"></div>
    <div id="successMessage" class="success-message"></div>
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Generating chart...</p>
    </div>

    <!-- Charts Grid -->
    <div class="row">
        <!-- Main Chart -->
        <div class="col-md-8">
            <div class="chart-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        <span id="chartTitle">Data Visualization</span>
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="toggleFullscreen()" title="Fullscreen">
                            <i class="bi bi-fullscreen"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetChart()" title="Reset">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                        <div id="chartPlaceholder" class="chart-placeholder">
                            <div>
                                <i class="bi bi-graph-up" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <br>
                                Select a table and configure axes to generate charts
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Statistics -->
        <div class="col-md-4">
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-data me-2"></i>
                        Chart Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div id="chartStats">
                        <div class="text-center text-muted">
                            <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                            <p class="mt-2">Generate a chart to view statistics</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Configuration -->
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>
                        Chart Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-controls">
                        <div class="mb-3">
                            <label for="chartTitleInput" class="form-label">Chart Title:</label>
                            <input type="text" id="chartTitleInput" class="form-control" placeholder="Enter chart title">
                        </div>
                        
                        <div class="mb-3">
                            <label for="colorScheme" class="form-label">Color Scheme:</label>
                            <select id="colorScheme" class="form-select">
                                <option value="default">Default</option>
                                <option value="blue">Blue Gradient</option>
                                <option value="green">Green Gradient</option>
                                <option value="red">Red Gradient</option>
                                <option value="purple">Purple Gradient</option>
                                <option value="rainbow">Rainbow</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showGridLines" checked>
                                <label class="form-check-label" for="showGridLines">
                                    Show Grid Lines
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showLegend" checked>
                                <label class="form-check-label" for="showLegend">
                                    Show Legend
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="animateChart" checked>
                                <label class="form-check-label" for="animateChart">
                                    Animate Chart
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-outline-primary w-100" onclick="applySettings()">
                            <i class="bi bi-check2"></i> Apply Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Secondary Charts Row -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Distribution Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                        <div id="distributionPlaceholder" class="chart-placeholder">
                            <div>
                                <i class="bi bi-pie-chart" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <br>
                                Auto-generated based on your main chart
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="chart-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-down me-2"></i>
                        Trend Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                        <div id="trendPlaceholder" class="chart-placeholder">
                            <div>
                                <i class="bi bi-graph-down" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                                <br>
                                Time-based trend visualization
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentChart = null;
let distributionChart = null;
let trendChart = null;
let currentDatabase = null;
let currentTable = null;
let currentChartType = 'bar';
let tableData = null;

// Color schemes
const colorSchemes = {
    default: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
    blue: ['#0066CC', '#3399FF', '#66B2FF', '#99CCFF', '#CCE5FF'],
    green: ['#009900', '#33CC33', '#66FF66', '#99FF99', '#CCFFCC'],
    red: ['#CC0000', '#FF3333', '#FF6666', '#FF9999', '#FFCCCC'],
    purple: ['#6600CC', '#9933FF', '#B366FF', '#CC99FF', '#E5CCFF'],
    rainbow: ['#FF0000', '#FF8000', '#FFFF00', '#80FF00', '#00FF00', '#00FF80', '#00FFFF', '#0080FF', '#0000FF', '#8000FF']
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDatabases();
    setupEventListeners();
});

function setupEventListeners() {
    // Chart settings change listeners
    document.getElementById('chartTitleInput').addEventListener('input', updateChartTitle);
    document.getElementById('colorScheme').addEventListener('change', applySettings);
    document.getElementById('showGridLines').addEventListener('change', applySettings);
    document.getElementById('showLegend').addEventListener('change', applySettings);
    document.getElementById('animateChart').addEventListener('change', applySettings);
}

// Database Management
async function loadDatabases() {
    try {
        const response = await fetch('/api/databases/available');
        const data = await response.json();
        
        const select = document.getElementById('databaseSelect');
        select.innerHTML = '<option value="">Select a database...</option>';
        
        if (data.success && data.databases) {
            data.databases.forEach(db => {
                const option = document.createElement('option');
                option.value = db.name;
                option.textContent = `${db.name} (${db.table_count} tables)`;
                select.appendChild(option);
            });
            
            // Auto-select first database if available
            if (data.databases.length > 0) {
                select.value = data.databases[0].name;
                onDatabaseChange();
            }
        }
    } catch (error) {
        showError('Failed to load databases: ' + error.message);
    }
}

async function onDatabaseChange() {
    const select = document.getElementById('databaseSelect');
    currentDatabase = select.value;
    
    if (!currentDatabase) {
        updateDatabaseInfo(0);
        loadTables([]);
        return;
    }
    
    try {
        const response = await fetch(`/api/database/tables/${currentDatabase}`);
        const data = await response.json();
        
        if (data.success) {
            updateDatabaseInfo(data.tables.length);
            loadTables(data.tables);
        } else {
            showError('Failed to load tables: ' + data.error);
            loadTables([]);
        }
    } catch (error) {
        showError('Failed to load tables: ' + error.message);
        loadTables([]);
    }
}

function updateDatabaseInfo(tableCount) {
    document.getElementById('dbTableCount').textContent = tableCount;
}

function loadTables(tables) {
    const select = document.getElementById('tableSelect');
    select.innerHTML = '<option value="">Choose a table...</option>';
    
    tables.forEach(table => {
        const option = document.createElement('option');
        option.value = table.name;
        option.textContent = `${table.name} (${table.row_count} rows)`;
        select.appendChild(option);
    });
    
    // Clear dependent selects
    clearAxisSelects();
    resetCharts();
}

async function onTableChange() {
    const tableSelect = document.getElementById('tableSelect');
    currentTable = tableSelect.value;
    
    if (!currentTable || !currentDatabase) {
        clearAxisSelects();
        return;
    }
    
    try {
        showLoading(true);
        const response = await fetch(`/api/relationships/columns/${currentTable}?database=${currentDatabase}`);
        const data = await response.json();
        
        if (data.success) {
            populateAxisSelects(data.columns);
            await loadTableData();
        } else {
            showError('Failed to load table columns: ' + data.error);
        }
    } catch (error) {
        showError('Failed to load table columns: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function populateAxisSelects(columns) {
    const xAxisSelect = document.getElementById('xAxisSelect');
    const yAxisSelect = document.getElementById('yAxisSelect');
    
    // Clear existing options
    xAxisSelect.innerHTML = '<option value="">Choose X-axis...</option>';
    yAxisSelect.innerHTML = '<option value="">Choose Y-axis...</option>';
    
    columns.forEach(column => {
        // X-axis options (all columns)
        const xOption = document.createElement('option');
        xOption.value = column.name;
        xOption.textContent = `${column.name} (${column.type})`;
        xAxisSelect.appendChild(xOption);
        
        // Y-axis options (numeric columns preferred)
        const yOption = document.createElement('option');
        yOption.value = column.name;
        yOption.textContent = `${column.name} (${column.type})`;
        yAxisSelect.appendChild(yOption);
    });
}

function clearAxisSelects() {
    document.getElementById('xAxisSelect').innerHTML = '<option value="">Choose X-axis...</option>';
    document.getElementById('yAxisSelect').innerHTML = '<option value="">Choose Y-axis...</option>';
}

async function loadTableData() {
    if (!currentTable || !currentDatabase) return;
    
    try {
        const response = await fetch(`/api/analyze-table/${currentTable}?database=${currentDatabase}`);
        const data = await response.json();
        
        if (data.success) {
            tableData = data.analysis;
            updateChartStats(data.analysis);
        } else {
            showError('Failed to load table data: ' + data.error);
        }
    } catch (error) {
        showError('Failed to load table data: ' + error.message);
    }
}

// Chart Type Selection
function selectChartType(type) {
    currentChartType = type;
    
    // Update UI
    document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('active');
}

// Chart Generation
async function generateChart() {
    const xAxis = document.getElementById('xAxisSelect').value;
    const yAxis = document.getElementById('yAxisSelect').value;
    
    if (!currentTable || !xAxis || !yAxis) {
        showError('Please select a table and both X and Y axis columns');
        return;
    }
    
    try {
        showLoading(true);
        
        // Fetch chart data
        const response = await fetch('/api/chart-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                database: currentDatabase,
                table: currentTable,
                x_column: xAxis,
                y_column: yAxis,
                chart_type: currentChartType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            createChart(data.chart_data);
            createDistributionChart(data.distribution_data);
            createTrendChart(data.trend_data);
            enableExportButtons();
            showSuccess('Chart generated successfully!');
        } else {
            showError('Failed to generate chart: ' + data.error);
        }
    } catch (error) {
        showError('Failed to generate chart: ' + error.message);
    } finally {
        showLoading(false);
    }
}

function createChart(chartData) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    
    // Destroy existing chart
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Hide placeholder
    document.getElementById('chartPlaceholder').style.display = 'none';
    
    const colors = getColors();
    
    currentChart = new Chart(ctx, {
        type: currentChartType,
        data: {
            labels: chartData.labels,
            datasets: [{
                label: chartData.label || 'Data',
                data: chartData.data,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('0.8', '1')),
                borderWidth: 2
            }]
        },
        options: getChartOptions()
    });
    
    updateChartTitle();
}

function createDistributionChart(distributionData) {
    if (!distributionData) return;
    
    const ctx = document.getElementById('distributionChart').getContext('2d');
    
    if (distributionChart) {
        distributionChart.destroy();
    }
    
    document.getElementById('distributionPlaceholder').style.display = 'none';
    
    distributionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: distributionData.labels,
            datasets: [{
                data: distributionData.data,
                backgroundColor: getColors()
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function createTrendChart(trendData) {
    if (!trendData) return;
    
    const ctx = document.getElementById('trendChart').getContext('2d');
    
    if (trendChart) {
        trendChart.destroy();
    }
    
    document.getElementById('trendPlaceholder').style.display = 'none';
    
    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: trendData.labels,
            datasets: [{
                label: 'Trend',
                data: trendData.data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function getColors() {
    const scheme = document.getElementById('colorScheme').value;
    return colorSchemes[scheme] || colorSchemes.default;
}

function getChartOptions() {
    const showGrid = document.getElementById('showGridLines').checked;
    const showLegend = document.getElementById('showLegend').checked;
    const animate = document.getElementById('animateChart').checked;
    
    return {
        responsive: true,
        maintainAspectRatio: false,
        animation: animate ? {} : false,
        plugins: {
            legend: {
                display: showLegend,
                position: 'top'
            }
        },
        scales: currentChartType !== 'pie' && currentChartType !== 'doughnut' ? {
            x: {
                grid: {
                    display: showGrid
                }
            },
            y: {
                grid: {
                    display: showGrid
                },
                beginAtZero: true
            }
        } : undefined
    };
}

// Chart Settings
function updateChartTitle() {
    const titleInput = document.getElementById('chartTitleInput');
    const titleElement = document.getElementById('chartTitle');
    
    if (titleInput.value.trim()) {
        titleElement.textContent = titleInput.value;
    } else {
        titleElement.textContent = `${currentTable || 'Data'} Visualization`;
    }
    
    if (currentChart) {
        currentChart.options.plugins.title = {
            display: true,
            text: titleElement.textContent
        };
        currentChart.update();
    }
}

function applySettings() {
    if (currentChart) {
        // Update colors
        const colors = getColors();
        currentChart.data.datasets[0].backgroundColor = colors;
        currentChart.data.datasets[0].borderColor = colors.map(color => color.replace('0.8', '1'));
        
        // Update options
        currentChart.options = getChartOptions();
        currentChart.update();
    }
    
    updateChartTitle();
}

function resetChart() {
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
    if (distributionChart) {
        distributionChart.destroy();
        distributionChart = null;
    }
    if (trendChart) {
        trendChart.destroy();
        trendChart = null;
    }
    
    resetCharts();
    disableExportButtons();
}

function resetCharts() {
    document.getElementById('chartPlaceholder').style.display = 'flex';
    document.getElementById('distributionPlaceholder').style.display = 'flex';
    document.getElementById('trendPlaceholder').style.display = 'flex';
    
    // Reset chart stats
    document.getElementById('chartStats').innerHTML = `
        <div class="text-center text-muted">
            <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
            <p class="mt-2">Generate a chart to view statistics</p>
        </div>
    `;
}

// Chart Statistics
function updateChartStats(analysis) {
    const statsContainer = document.getElementById('chartStats');
    
    if (!analysis) {
        statsContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="bi bi-graph-up" style="font-size: 2rem;"></i>
                <p class="mt-2">No statistics available</p>
            </div>
        `;
        return;
    }
    
    statsContainer.innerHTML = `
        <div class="row text-center">
            <div class="col-6 mb-3">
                <div class="metric-card bg-primary text-white">
                    <div class="metric-value">${analysis.total_rows || 0}</div>
                    <div class="metric-label">Total Rows</div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="metric-card bg-success text-white">
                    <div class="metric-value">${analysis.numeric_columns || 0}</div>
                    <div class="metric-label">Numeric Columns</div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="metric-card bg-info text-white">
                    <div class="metric-value">${analysis.null_percentage || 0}%</div>
                    <div class="metric-label">Null Values</div>
                </div>
            </div>
            <div class="col-6 mb-3">
                <div class="metric-card bg-warning text-white">
                    <div class="metric-value">${analysis.unique_values || 0}</div>
                    <div class="metric-label">Unique Values</div>
                </div>
            </div>
        </div>
    `;
}

// Export Functions
function enableExportButtons() {
    document.getElementById('exportPNG').disabled = false;
    document.getElementById('exportJPG').disabled = false;
    document.getElementById('exportPDF').disabled = false;
}

function disableExportButtons() {
    document.getElementById('exportPNG').disabled = true;
    document.getElementById('exportJPG').disabled = true;
    document.getElementById('exportPDF').disabled = true;
}

function exportChart(format) {
    if (!currentChart) {
        showError('No chart to export');
        return;
    }
    
    const canvas = document.getElementById('mainChart');
    const link = document.createElement('a');
    
    if (format === 'png' || format === 'jpg') {
        const imageType = format === 'png' ? 'image/png' : 'image/jpeg';
        link.href = canvas.toDataURL(imageType);
        link.download = `chart.${format}`;
        link.click();
    } else if (format === 'pdf') {
        // For PDF export, we would need a library like jsPDF
        showError('PDF export not implemented yet');
    }
}

// Utility Functions
function refreshTableData() {
    if (currentTable && currentDatabase) {
        loadTableData();
        showSuccess('Data refreshed successfully!');
    } else {
        showError('Please select a table first');
    }
}

function toggleFullscreen() {
    const chartCard = document.querySelector('.chart-card');
    if (chartCard.requestFullscreen) {
        chartCard.requestFullscreen();
    }
}

function showLoading(show) {
    document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 3000);
}
</script>
{% endblock %}
