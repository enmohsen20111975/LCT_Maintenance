{% extends "base.html" %}

{% block title %}Stock Analysis - LDA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-graph-up"></i> Comprehensive Stock Analysis</h2>
                <p class="text-muted mb-0">
                    Cross-reference analysis using Stock, PO, PR, and Annual tables
                </p>
            </div>
            <div class="d-flex gap-2">
                <button id="refreshAnalysis" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button id="exportAnalysis" class="btn btn-success">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Summary Row -->
{% if alerts and alerts.success %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Stock Alerts</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if alerts.alerts.get('OUT_OF_STOCK') %}
                    <div class="col-md-3">
                        <div class="alert alert-danger mb-2">
                            <strong>{{ alerts.alerts['OUT_OF_STOCK']|length }}</strong> items out of stock
                        </div>
                    </div>
                    {% endif %}
                    {% if alerts.alerts.get('REORDER_NEEDED') %}
                    <div class="col-md-3">
                        <div class="alert alert-warning mb-2">
                            <strong>{{ alerts.alerts['REORDER_NEEDED']|length }}</strong> items need reorder
                        </div>
                    </div>
                    {% endif %}
                    {% if alerts.alerts.get('EXCESS_STOCK') %}
                    <div class="col-md-3">
                        <div class="alert alert-info mb-2">
                            <strong>{{ alerts.alerts['EXCESS_STOCK']|length }}</strong> excess stock items
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <button class="btn btn-outline-warning btn-sm" onclick="showDetailedAlerts()">
                            <i class="bi bi-eye"></i> View All Alerts
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Analysis Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-sliders"></i> Analysis Filters</h5>
            </div>
            <div class="card-body">
                <form id="analysisForm" class="row g-3">
                    <div class="col-md-3">
                        <label for="articleFilter" class="form-label">Article Reference</label>
                        <input type="text" class="form-control" id="articleFilter" 
                               placeholder="Search by article reference..." 
                               value="{{ article_filter }}">
                    </div>
                    <div class="col-md-2">
                        <label for="limitFilter" class="form-label">Limit Results</label>
                        <select class="form-control" id="limitFilter">
                            <option value="50">50 items</option>
                            <option value="100" {% if limit == 100 %}selected{% endif %}>100 items</option>
                            <option value="500">500 items</option>
                            <option value="1000">1000 items</option>
                            <option value="">All items</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="analysisType" class="form-label">Analysis Type</label>
                        <select class="form-control" id="analysisType">
                            <option value="comprehensive">Comprehensive Analysis</option>
                            <option value="critical_only">Critical Items Only</option>
                            <option value="with_po">Items with Purchase Orders</option>
                            <option value="with_pr">Items with Purchase Requests</option>
                            <option value="annual_trends">Annual Trends Focus</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary d-block">
                            <i class="bi bi-search"></i> Analyze
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="text-center py-4" style="display: none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading comprehensive stock analysis...</p>
</div>

<!-- Analysis Results Container -->
<div id="analysisResults">
    <!-- Results will be loaded here via AJAX -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-table"></i> Stock Analysis Results</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Click "Analyze" to load comprehensive stock analysis results...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Detailed Alerts -->
<div class="modal fade" id="alertsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Detailed Stock Alerts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="alertsModalBody">
                <!-- Alert details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Modal for Export Options -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-download"></i> Export Stock Analysis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Export Format</label>
                        <select class="form-control" id="exportFormat">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportLimit" class="form-label">Number of Records</label>
                        <select class="form-control" id="exportLimit">
                            <option value="">All records</option>
                            <option value="1000">1000 records</option>
                            <option value="5000">5000 records</option>
                            <option value="10000">10000 records</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="executeExport()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.alert-summary {
    border-radius: 8px;
    font-size: 0.9rem;
}

.analysis-metric {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #007bff;
}

.metric-label {
    font-size: 0.9rem;
    color: #6c757d;
}

.table-responsive {
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.badge-status {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
}

.progress-sm {
    height: 8px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the analysis form
    document.getElementById('analysisForm').addEventListener('submit', function(e) {
        e.preventDefault();
        loadAnalysis();
    });
    
    // Initialize refresh button
    document.getElementById('refreshAnalysis').addEventListener('click', function() {
        loadAnalysis();
    });
    
    // Initialize export button
    document.getElementById('exportAnalysis').addEventListener('click', function() {
        new bootstrap.Modal(document.getElementById('exportModal')).show();
    });
    
    // Load initial analysis if no filters are set
    if (!document.getElementById('articleFilter').value) {
        loadAnalysis();
    }
});

function loadAnalysis() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('analysisResults');
    
    // Show loading indicator
    loadingIndicator.style.display = 'block';
    resultsContainer.style.display = 'none';
    
    // Get form parameters
    const params = new URLSearchParams({
        article_filter: document.getElementById('articleFilter').value,
        limit: document.getElementById('limitFilter').value,
        analysis_type: document.getElementById('analysisType').value
    });
    
    // Make API call
    fetch(`/api/stock-analysis/comprehensive?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnalysisResults(data);
            } else {
                displayError(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error loading analysis:', error);
            displayError('Network error occurred');
        })
        .finally(() => {
            loadingIndicator.style.display = 'none';
            resultsContainer.style.display = 'block';
        });
}

function displayAnalysisResults(data) {
    const container = document.getElementById('analysisResults');
    
    let html = `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="analysis-metric text-center">
                    <div class="metric-value">${data.total_records}</div>
                    <div class="metric-label">Total Items</div>
                </div>
            </div>
    `;
    
    if (data.analysis && data.analysis.summary) {
        const summary = data.analysis.summary;
        html += `
            <div class="col-md-3">
                <div class="analysis-metric text-center">
                    <div class="metric-value">$${(summary.total_stock_value || 0).toLocaleString()}</div>
                    <div class="metric-label">Total Stock Value</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="analysis-metric text-center">
                    <div class="metric-value">${summary.categories_count || 0}</div>
                    <div class="metric-label">Categories</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="analysis-metric text-center">
                    <div class="metric-value">$${(summary.avg_stock_value || 0).toFixed(2)}</div>
                    <div class="metric-label">Avg Item Value</div>
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    
    // Add data table
    html += `
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-table"></i> Stock Analysis Data</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="toggleAnalysisDetails()">
                                <i class="bi bi-eye"></i> Analysis Details
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Reference Article</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Stock Qty</th>
                                        <th>Unit Price</th>
                                        <th>Stock Value</th>
                                        <th>Status</th>
                                        <th>PO Info</th>
                                        <th>PR Info</th>
                                        <th>Annual Trend</th>
                                    </tr>
                                </thead>
                                <tbody>
    `;
    
    if (data.data && data.data.length > 0) {
        data.data.forEach(item => {
            const stockStatus = item.stock_status || 'NORMAL';
            const statusClass = getStatusClass(stockStatus);
            const stockValue = (item.stock_value || 0).toLocaleString();
            
            html += `
                <tr>
                    <td><strong>${item.reference_article || ''}</strong></td>
                    <td>${item.stock_designation || ''}</td>
                    <td><span class="badge bg-info">${item.categorie_article || ''}</span></td>
                    <td>${item.quantite_en_stock || 0}</td>
                    <td>$${(item.unit_price || 0).toFixed(2)}</td>
                    <td>$${stockValue}</td>
                    <td><span class="badge ${statusClass}">${stockStatus}</span></td>
                    <td>${item.po_number ? `<small>PO: ${item.po_number}<br>Qty: ${item.po_quantity_ordered || 0}</small>` : '<small class="text-muted">No PO</small>'}</td>
                    <td>${item.pr_number ? `<small>PR: ${item.pr_number}<br>Qty: ${item.pr_quantity_requested || 0}</small>` : '<small class="text-muted">No PR</small>'}</td>
                    <td>${getTrendDisplay(item)}</td>
                </tr>
            `;
        });
    } else {
        html += '<tr><td colspan="10" class="text-center text-muted">No data available</td></tr>';
    }
    
    html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add analysis details section (initially hidden)
    if (data.analysis) {
        html += `
            <div class="row mt-4" id="analysisDetailsSection" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-graph-up"></i> Analysis Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
        `;
        
        // Add various analysis sections
        if (data.analysis.stock_status_distribution) {
            html += createAnalysisSection('Stock Status Distribution', data.analysis.stock_status_distribution);
        }
        
        if (data.analysis.critical_items) {
            html += createCriticalItemsSection(data.analysis.critical_items);
        }
        
        if (data.analysis.top_value_items) {
            html += createTopValueItemsSection(data.analysis.top_value_items);
        }
        
        html += `
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function getStatusClass(status) {
    switch (status) {
        case 'CRITICAL': return 'bg-danger';
        case 'LOW': return 'bg-warning';
        case 'EXCESS': return 'bg-info';
        case 'NORMAL': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function getTrendDisplay(item) {
    let trend = '';
    if (item.trend_2025) {
        const trendClass = item.trend_2025 === 'UP' ? 'text-success' : 
                          item.trend_2025 === 'DOWN' ? 'text-danger' : 'text-muted';
        trend = `<small class="${trendClass}">${item.trend_2025}</small>`;
    }
    if (item.usage_2024 && item.usage_2025) {
        trend += `<br><small>2024: ${item.usage_2024}<br>2025: ${item.usage_2025}</small>`;
    }
    return trend || '<small class="text-muted">No trend data</small>';
}

function createAnalysisSection(title, data) {
    let html = `
        <div class="col-md-6 mb-3">
            <h6>${title}</h6>
            <div class="card bg-light">
                <div class="card-body">
    `;
    
    Object.entries(data).forEach(([key, value]) => {
        const percentage = Object.values(data).reduce((a, b) => a + b, 0);
        const percent = percentage > 0 ? ((value / percentage) * 100).toFixed(1) : 0;
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>${key.replace(/_/g, ' ').toUpperCase()}</span>
                <span><strong>${value}</strong> (${percent}%)</span>
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
        </div>
    `;
    return html;
}

function createCriticalItemsSection(criticalData) {
    let html = `
        <div class="col-md-6 mb-3">
            <h6>Critical Items Analysis</h6>
            <div class="card bg-light">
                <div class="card-body">
                    <p><strong>Count:</strong> ${criticalData.count}</p>
                    <p><strong>Total Value:</strong> $${(criticalData.total_value || 0).toLocaleString()}</p>
    `;
    
    if (criticalData.items && criticalData.items.length > 0) {
        html += '<p><strong>Top Critical Items:</strong></p><ul>';
        criticalData.items.slice(0, 5).forEach(item => {
            html += `<li><small>${item.reference_article} - ${item.stock_designation} (Stock: ${item.quantite_en_stock})</small></li>`;
        });
        html += '</ul>';
    }
    
    html += `
                </div>
            </div>
        </div>
    `;
    return html;
}

function createTopValueItemsSection(topValueData) {
    let html = `
        <div class="col-md-6 mb-3">
            <h6>Top Value Items</h6>
            <div class="card bg-light">
                <div class="card-body">
                    <ul>
    `;
    
    topValueData.slice(0, 5).forEach(item => {
        html += `<li><small>${item.reference_article} - $${(item.stock_value || 0).toLocaleString()}</small></li>`;
    });
    
    html += `
                    </ul>
                </div>
            </div>
        </div>
    `;
    return html;
}

function toggleAnalysisDetails() {
    const section = document.getElementById('analysisDetailsSection');
    if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }
}

function displayError(message) {
    const container = document.getElementById('analysisResults');
    container.innerHTML = `
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                    <p>${message}</p>
                </div>
            </div>
        </div>
    `;
}

function showDetailedAlerts() {
    fetch('/api/stock-analysis/alerts')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDetailedAlerts(data.alerts);
            } else {
                alert('Error loading alerts: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error loading alerts:', error);
            alert('Network error occurred');
        });
}

function displayDetailedAlerts(alerts) {
    const modalBody = document.getElementById('alertsModalBody');
    let html = '';
    
    Object.entries(alerts).forEach(([alertType, items]) => {
        if (items.length > 0) {
            const alertClass = alertType === 'OUT_OF_STOCK' ? 'danger' : 
                              alertType === 'REORDER_NEEDED' ? 'warning' : 'info';
            
            html += `
                <div class="alert alert-${alertClass}">
                    <h6>${alertType.replace(/_/g, ' ').toUpperCase()} (${items.length} items)</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Reference</th>
                                    <th>Description</th>
                                    <th>Current Stock</th>
                                    <th>Min Level</th>
                                    <th>Stock Value</th>
                                    <th>Buyer</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            items.slice(0, 10).forEach(item => {
                html += `
                    <tr>
                        <td>${item.reference_article}</td>
                        <td>${item.designation_1 || ''}</td>
                        <td>${item.quantite_en_stock}</td>
                        <td>${item.seuil_de_reappro_min || 'N/A'}</td>
                        <td>$${(item.stock_value || 0).toLocaleString()}</td>
                        <td>${item.buyer || 'N/A'}</td>
                    </tr>
                `;
            });
            
            if (items.length > 10) {
                html += `<tr><td colspan="6" class="text-center text-muted">... and ${items.length - 10} more items</td></tr>`;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    });
    
    modalBody.innerHTML = html;
    new bootstrap.Modal(document.getElementById('alertsModal')).show();
}

function executeExport() {
    const format = document.getElementById('exportFormat').value;
    const limit = document.getElementById('exportLimit').value;
    
    const params = new URLSearchParams({
        format: format,
        limit: limit
    });
    
    fetch(`/api/stock-analysis/export?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Create download link
                const link = document.createElement('a');
                link.href = `/static/exports/${data.filename}`;
                link.download = data.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
                
                alert(`Export successful! Downloaded ${data.records_exported} records.`);
            } else {
                alert('Export failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Export error:', error);
            alert('Export failed: Network error');
        });
}
</script>
{% endblock %}
