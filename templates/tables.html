{% extends "base.html" %}

{% block title %}Tables - LDA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="bi bi-table"></i> Database Tables</h2>
                <p class="text-muted mb-0">
                    <span class="text-primary fw-bold">Current Database:</span> {{ current_db_name or 'excel_data' }}
                    <a href="{{ url_for('database_management') }}" class="btn btn-sm btn-outline-info ms-2">
                        <i class="bi bi-gear"></i> Manage
                    </a>
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('enhanced_upload') }}" class="btn btn-primary">
                    <i class="bi bi-gear"></i> Enhanced Upload
                </a>
                <a href="{{ url_for('upload') }}" class="btn btn-outline-primary">
                    <i class="bi bi-cloud-upload"></i> Quick Upload
                </a>
            </div>
        </div>
        
        <!-- Statistics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card primary">
                    <div class="stats-value">{{ stats.total_shown }}</div>
                    <div class="stats-label">
                        {% if stats.search_term %}
                            Matching "{{ stats.search_term }}"
                        {% elif stats.filter_type != 'all' %}
                            {{ stats.filter_type|title }} Tables
                        {% else %}
                            Total Tables
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card success">
                    <div class="stats-value">{{ "{:,}".format(stats.total_records) }}</div>
                    <div class="stats-label">Total Records</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card warning">
                    <div class="stats-value">{{ stats.orphaned_count }}</div>
                    <div class="stats-label">Need Repair</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card info">
                    {% if stats.orphaned_count > 0 %}
                        <button class="btn btn-sm btn-warning" onclick="repairAllMetadata()">
                            <i class="bi bi-wrench-adjustable"></i> Repair All
                        </button>
                    {% else %}
                        <div class="stats-value"><i class="bi bi-check-circle"></i></div>
                        <div class="stats-label">All Healthy</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Search and Filter Controls -->
        <div class="table-controls">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Search tables, sheets, or filenames..." 
                               value="{{ search }}"
                               onkeypress="if(event.key==='Enter') searchTables()">
                        <button class="btn btn-outline-secondary" type="button" onclick="searchTables()">
                            Search
                        </button>
                        {% if search %}
                        <button class="btn btn-outline-danger" type="button" onclick="clearSearch()">
                            <i class="bi bi-x"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="filterSelect" onchange="applyFilter()">
                        <option value="all" {{ 'selected' if filter_type == 'all' else '' }}>All Tables</option>
                        <option value="recent" {{ 'selected' if filter_type == 'recent' else '' }}>Recent (7 days)</option>
                        <option value="orphaned" {{ 'selected' if filter_type == 'orphaned' else '' }}>Need Repair</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="sortSelect" onchange="applySort()">
                        <option value="created_date:desc" {{ 'selected' if sort_by == 'created_date' and sort_order == 'desc' else '' }}>Newest First</option>
                        <option value="created_date:asc" {{ 'selected' if sort_by == 'created_date' and sort_order == 'asc' else '' }}>Oldest First</option>
                        <option value="table_name:asc" {{ 'selected' if sort_by == 'table_name' and sort_order == 'asc' else '' }}>Name A-Z</option>
                        <option value="table_name:desc" {{ 'selected' if sort_by == 'table_name' and sort_order == 'desc' else '' }}>Name Z-A</option>
                        <option value="row_count:desc" {{ 'selected' if sort_by == 'row_count' and sort_order == 'desc' else '' }}>Most Records</option>
                        <option value="row_count:asc" {{ 'selected' if sort_by == 'row_count' and sort_order == 'asc' else '' }}>Fewest Records</option>
                    </select>
                </div>
            </div>
        </div>
        
        {% if tables %}
        <!-- Bulk Actions -->
        {% set orphaned_tables = tables | selectattr('is_orphaned', 'defined') | selectattr('is_orphaned') | list %}
        {% if orphaned_tables %}
        <div class="alert alert-warning" role="alert">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-exclamation-triangle"></i> 
                    <strong>Found {{ orphaned_tables | length }} table(s) with missing metadata.</strong>
                    These tables exist in the database but don't have proper metadata records.
                </div>
                <button class="btn btn-sm btn-outline-warning" onclick="repairAllMetadata()">
                    <i class="bi bi-wrench-adjustable"></i> Repair All Metadata
                </button>
            </div>
        </div>
        {% endif %}
        
        <div class="table-container">
            <div class="table-responsive">
                <table class="table-enhanced">
                    <thead>
                        <tr>
                            <th>
                                <a href="javascript:void(0)" onclick="sortBy('table_name')">
                                    <i class="bi bi-table me-2"></i>Table Name 
                                    {% if sort_by == 'table_name' %}
                                        <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th><i class="bi bi-file-spreadsheet me-2"></i>Original Sheet</th>
                            <th>
                                <a href="javascript:void(0)" onclick="sortBy('column_count')">
                                    <i class="bi bi-list-columns me-2"></i>Columns
                                    {% if sort_by == 'column_count' %}
                                        <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="javascript:void(0)" onclick="sortBy('row_count')">
                                    <i class="bi bi-database me-2"></i>Records
                                    {% if sort_by == 'row_count' %}
                                        <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th>
                                <a href="javascript:void(0)" onclick="sortBy('created_date')">
                                    <i class="bi bi-calendar me-2"></i>Created Date
                                    {% if sort_by == 'created_date' %}
                                        <i class="bi bi-arrow-{{ 'up' if sort_order == 'asc' else 'down' }}"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th><i class="bi bi-gear me-2"></i>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for table in tables %}
                        <tr {% if table.get('is_orphaned') %}class="table-warning"{% endif %}>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="data-type-indicator type-text"></span>
                                    <strong>{{ table.table_name }}</strong>
                                    {% if table.get('is_orphaned') %}
                                        <span class="badge badge-warning ms-2" title="Table exists but missing metadata">
                                            <i class="bi bi-exclamation-triangle"></i> No Metadata
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {{ table.original_sheet_name if table.original_sheet_name != 'Unknown' else '' }}
                                {% if table.original_filename and table.original_filename != 'Unknown' %}
                                    <br><small class="text-muted">{{ table.original_filename }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge-enhanced badge-count">{{ table.column_count }}</span>
                            </td>
                            <td>
                                <span class="badge-enhanced badge-status">{{ "{:,}".format(table.row_count) }}</span>
                            </td>
                            <td>
                                {% if table.created_date and table.created_date != 'N/A' %}
                                    {% if table.created_date is string %}
                                        {{ table.created_date }}
                                    {% else %}
                                        {{ table.created_date.strftime('%Y-%m-%d') }}<br>
                                        <small class="text-muted">{{ table.created_date.strftime('%H:%M') }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group-enhanced" role="group">
                                    <a href="{{ url_for('view_table', table_name=table.table_name) }}" 
                                       class="btn btn-sm btn-outline-primary" title="View Data">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    {% if table.get('is_orphaned') %}
                                    <button class="btn btn-sm btn-outline-warning" 
                                            onclick="repairMetadata('{{ table.table_name }}')" 
                                            title="Repair Missing Metadata">
                                        <i class="bi bi-wrench"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="showTableInfo('{{ table.table_name }}')" 
                                            title="Table Info">
                                        <i class="bi bi-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="confirmDeleteTable('{{ table.table_name }}')" 
                                            title="Delete Table">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="bi bi-table"></i>
            <h4>
                {% if search %}
                    No tables match "{{ search }}"
                {% elif filter_type != 'all' %}
                    No {{ filter_type }} tables found
                {% else %}
                    No Tables Found
                {% endif %}
            </h4>
            <p>
                {% if search or filter_type != 'all' %}
                    Try adjusting your search or filter criteria.
                {% else %}
                    Upload a data file to create your first database table.
                {% endif %}
            </p>
            <div class="mt-3">
                {% if search or filter_type != 'all' %}
                <button class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                    <i class="bi bi-arrow-clockwise"></i> Clear Filters
                </button>
                {% endif %}
                <a href="{{ url_for('enhanced_upload') }}" class="btn btn-primary">
                    <i class="bi bi-gear"></i> Enhanced Upload
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Table Info Modal -->
<div class="modal fade" id="tableInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Table Information</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="tableInfoContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteTableModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the table <strong id="deleteTableName"></strong>?</p>
                <p class="text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    This action cannot be undone. All data in this table will be permanently lost.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Table</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Search functionality
function searchTables() {
    const search = document.getElementById('searchInput').value;
    updateUrl({search: search});
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    updateUrl({search: ''});
}

// Filter functionality  
function applyFilter() {
    const filter = document.getElementById('filterSelect').value;
    updateUrl({filter: filter});
}

// Sort functionality
function applySort() {
    const sortValue = document.getElementById('sortSelect').value;
    const [sort_by, sort_order] = sortValue.split(':');
    updateUrl({sort_by: sort_by, sort_order: sort_order});
}

function sortBy(column) {
    const currentSortBy = '{{ sort_by }}';
    const currentSortOrder = '{{ sort_order }}';
    
    let newSortOrder = 'asc';
    if (currentSortBy === column && currentSortOrder === 'asc') {
        newSortOrder = 'desc';
    }
    
    updateUrl({sort_by: column, sort_order: newSortOrder});
}

// Clear all filters
function clearFilters() {
    updateUrl({search: '', filter: 'all', sort_by: 'created_date', sort_order: 'desc'});
}

// URL update helper
function updateUrl(params) {
    const url = new URL(window.location);
    
    Object.keys(params).forEach(key => {
        if (params[key] === '' || params[key] === 'all') {
            url.searchParams.delete(key);
        } else {
            url.searchParams.set(key, params[key]);
        }
    });
    
    window.location = url.toString();
}

// Table info modal
function showTableInfo(tableName) {
    const modal = new bootstrap.Modal(document.getElementById('tableInfoModal'));
    const content = document.getElementById('tableInfoContent');
    
    content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
    modal.show();
    
    fetch(`/api/table/${tableName}/info`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const info = data.table_info;
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>General Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Table Name:</strong></td><td>${info.table_name}</td></tr>
                                <tr><td><strong>Original Sheet:</strong></td><td>${info.original_sheet_name}</td></tr>
                                <tr><td><strong>Columns:</strong></td><td>${info.column_count}</td></tr>
                                <tr><td><strong>Records:</strong></td><td>${info.actual_row_count}</td></tr>
                                <tr><td><strong>Created:</strong></td><td>${new Date(info.created_date).toLocaleDateString()}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Column Structure</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead><tr><th>Column</th><th>Type</th></tr></thead>
                                    <tbody>
                                        ${info.columns.map(col => `<tr><td>${col.name}</td><td><code>${col.type}</code></td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                content.innerHTML = '<div class="alert alert-danger">Failed to load table information.</div>';
            }
        })
        .catch(error => {
            content.innerHTML = '<div class="alert alert-danger">Error loading table information.</div>';
        });
}

// Delete table confirmation
function confirmDeleteTable(tableName) {
    document.getElementById('deleteTableName').textContent = tableName;
    document.getElementById('confirmDeleteBtn').onclick = () => deleteTable(tableName);
    
    const modal = new bootstrap.Modal(document.getElementById('deleteTableModal'));
    modal.show();
}

function deleteTable(tableName) {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';
    
    fetch(`/api/table/${tableName}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to delete table: ' + (data.error || 'Unknown error'));
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = 'Delete Table';
        }
    })
    .catch(error => {
        alert('Error deleting table');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = 'Delete Table';
    });
}

// Repair metadata functionality
function repairMetadata(tableName) {
    if (confirm(`Repair metadata for table "${tableName}"?`)) {
        fetch(`/api/repair-metadata/${tableName}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error repairing metadata: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error repairing metadata: ' + error.message);
        });
    }
}

function repairAllMetadata() {
    if (confirm('Repair metadata for all orphaned tables?')) {
        fetch('/api/repair-all-metadata', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Successfully repaired metadata for ${data.repaired_count} table(s).`);
                location.reload();
            } else {
                alert('Error repairing metadata: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error repairing metadata: ' + error.message);
        });
    }
}
</script>
{% endblock %}
