{% extends "base.html" %}

{% block title %}Work Orders Analysis Simple - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="fas fa-chart-line"></i> Work Orders Analysis</h1>
            <p class="text-muted">Simple version without charts - showing data from Activity database</p>
        </div>
    </div>

    <!-- Loading indicator -->
    <div id="loading" class="text-center my-5">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2">Loading work orders analysis...</p>
    </div>

    <!-- Content container -->
    <div id="content" style="display: none;">
        
        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h2 id="total-orders">-</h2>
                        <p>Total Work Orders</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h2 id="completion-rate">-</h2>
                        <p>Completion Rate</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h2 id="cp-ratio">-</h2>
                        <p>C:P Ratio</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-white bg-danger">
                    <div class="card-body text-center">
                        <h2 id="urgent-percentage">-</h2>
                        <p>Urgent Orders</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Job Type Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="job-types-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Priority Distribution</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Priority</th>
                                        <th>Count</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="priorities-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Top Equipment by Work Orders</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Equipment</th>
                                        <th>Work Orders</th>
                                        <th>Avg Downtime (hrs)</th>
                                        <th>Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="equipment-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Insights & Recommendations</h5>
                    </div>
                    <div class="card-body" id="insights-container">
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    loadData();
});

function loadData() {
    $.ajax({
        url: '/api/work-orders/analysis',
        method: 'GET',
        timeout: 60000,
        success: function(response) {
            if (response.success) {
                displayData(response.analysis);
                $('#loading').hide();
                $('#content').show();
            } else {
                showError('Failed to load data: ' + response.error);
            }
        },
        error: function(xhr, status, error) {
            showError('Error loading data: ' + error);
        }
    });
}

function displayData(data) {
    // KPIs
    $('#total-orders').text((data.basic_stats.total_records || 0).toLocaleString());
    $('#completion-rate').text((data.basic_stats.completed_percentage || 0) + '%');
    $('#cp-ratio').text(data.performance.corrective_preventive_ratio || 0);
    $('#urgent-percentage').text((data.performance.urgent_percentage || 0) + '%');
    
    // Job Types Table
    let jobTypesHtml = '';
    (data.job_types || []).forEach(jt => {
        jobTypesHtml += `
            <tr>
                <td>${jt.name}</td>
                <td>${jt.count}</td>
                <td>${jt.percentage}%</td>
            </tr>
        `;
    });
    $('#job-types-table').html(jobTypesHtml);
    
    // Priorities Table
    let prioritiesHtml = '';
    (data.priorities || []).forEach(p => {
        prioritiesHtml += `
            <tr>
                <td>${p.name}</td>
                <td>${p.count}</td>
                <td>${p.percentage}%</td>
            </tr>
        `;
    });
    $('#priorities-table').html(prioritiesHtml);
    
    // Equipment Table
    let equipmentHtml = '';
    (data.equipment || []).slice(0, 15).forEach(eq => {
        equipmentHtml += `
            <tr>
                <td><strong>${eq.equipment}</strong><br><small>${eq.equipment_name}</small></td>
                <td>${eq.work_orders}</td>
                <td>${eq.avg_downtime}</td>
                <td>${eq.percentage}%</td>
            </tr>
        `;
    });
    $('#equipment-table').html(equipmentHtml);
    
    // Insights
    let insightsHtml = '';
    (data.insights || []).forEach(insight => {
        const alertClass = insight.type === 'warning' ? 'alert-warning' : 
                          insight.type === 'success' ? 'alert-success' : 'alert-info';
        insightsHtml += `
            <div class="alert ${alertClass}">
                <h6>${insight.title}</h6>
                <p>${insight.message}</p>
                <small><strong>Recommendation:</strong> ${insight.recommendation}</small>
            </div>
        `;
    });
    $('#insights-container').html(insightsHtml);
}

function showError(message) {
    $('#loading').hide();
    $('#content').html(`
        <div class="alert alert-danger">
            <h4>Error</h4>
            <p>${message}</p>
        </div>
    `).show();
}
</script>
{% endblock %}
