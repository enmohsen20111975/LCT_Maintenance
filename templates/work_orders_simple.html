{% extends "base.html" %}

{% block title %}Work Orders - LCT STS Maintenance{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">
    
    <!-- Error Display -->
    {% if error %}
    <div class="alert alert-danger">
        <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Work Orders</h4>
        <p>{{ error }}</p>
        <div class="mt-3">
            <a href="{{ url_for('index') }}" class="btn btn-primary">Return to Home</a>
            <button onclick="window.location.reload()" class="btn btn-outline-primary">Refresh Page</button>
        </div>
    </div>
    {% else %}
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="fas fa-wrench text-primary"></i> Work Orders Management</h1>
            <p class="text-muted">View and manage all work orders</p>
        </div>
        <div>
            <a href="{{ url_for('work_orders_powerbi') }}" class="btn btn-primary">
                <i class="fas fa-chart-bar"></i> Advanced Analytics
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-list fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">Total Work Orders</h5>
                            <h2 class="mb-0">{{ work_orders|length if work_orders else 0 }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if stats %}
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-play-circle fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">Active</h5>
                            <h2 class="mb-0">{{ stats.total_active|default(0) }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-history fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">History</h5>
                            <h2 class="mb-0">{{ stats.total_history|default(0) }}</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-database fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">Source</h5>
                            <h6 class="mb-0">{{ database_source|default('All Data') }}</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Options -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter"></i> Quick Filters</h5>
                </div>
                <div class="card-body">
                    <!-- Date Range Filter -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Performance Notice:</strong> Currently showing <strong>Current Year (2025)</strong> data only for optimal performance. 
                                <a href="{{ url_for('work_orders_powerbi') }}" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-calendar"></i> Advanced Date Filters
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Filters -->
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('work_orders_list') }}" class="btn btn-outline-primary w-100 mb-2 {% if not current_filters.status %}active{% endif %}">
                                <i class="fas fa-list"></i> All Work Orders (2025)
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('work_orders_list', status='Active') }}" class="btn btn-outline-success w-100 mb-2 {% if current_filters.status == 'Active' %}active{% endif %}">
                                <i class="fas fa-play-circle"></i> Active Only
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('work_orders_list', status='Completed') }}" class="btn btn-outline-info w-100 mb-2 {% if current_filters.status == 'Completed' %}active{% endif %}">
                                <i class="fas fa-check-circle"></i> Completed Only
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('work_orders_list', priority='High') }}" class="btn btn-outline-danger w-100 mb-2 {% if current_filters.priority == 'High' %}active{% endif %}">
                                <i class="fas fa-exclamation-triangle"></i> High Priority
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Orders Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table"></i> Work Orders List
                {% if current_filters %}
                    <span class="badge bg-secondary">Filtered</span>
                {% endif %}
            </h5>
            <div>
                <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
                <a href="{{ url_for('work_orders_list') }}?export=csv" class="btn btn-sm btn-outline-success">
                    <i class="fas fa-file-csv"></i> Export CSV
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if work_orders %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>WO Number</th>
                            <th>Description</th>
                            <th>Equipment</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Creation Date</th>
                            <th>Execution Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for wo in work_orders %}
                        <tr>
                            <td>
                                <strong>{{ wo.wo_name|default('N/A') }}</strong>
                            </td>
                            <td>
                                <span title="{{ wo.description|default('No description') }}">
                                    {{ (wo.description[:80] + '...') if wo.description and wo.description|length > 80 else (wo.description|default('No description')) }}
                                </span>
                            </td>
                            <td>{{ wo.equipement|default('N/A') }}</td>
                            <td>
                                {% set status = wo.etatjob|default('Unknown') %}
                                <span class="badge bg-{% if status in ['TER', 'Completed', 'Done'] %}success{% elif status in ['EXE', 'INI', 'PRT'] %}primary{% elif status in ['APC', 'Pending'] %}warning{% else %}secondary{% endif %}">
                                    {{ status }}
                                </span>
                            </td>
                            <td>
                                {% set priority = wo.priority_key|default('N/A') %}
                                <span class="badge bg-{% if 'IMM' in priority or 'HIGH' in priority or '1-' in priority %}danger{% elif 'MED' in priority or '2-' in priority %}warning{% elif 'LOW' in priority or '3-' in priority %}success{% else %}secondary{% endif %}">
                                    {{ priority }}
                                </span>
                            </td>
                            <td>{{ wo.order_date[:10] if wo.order_date else 'N/A' }}</td>
                            <td>{{ wo.jobexec_dt[:10] if wo.jobexec_dt else 'N/A' }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="showWorkOrderDetails('{{ wo.wo_key|default('') }}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="editWorkOrder('{{ wo.wo_key|default('') }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Info -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted">
                    Showing {{ work_orders|length }} work orders
                    {% if current_filters %}(filtered results){% endif %}
                </div>
                <div>
                    {% if page > 1 %}
                    <a href="{{ url_for('work_orders_list', page=page-1, **current_filters) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                    {% endif %}
                    <span class="mx-2">Page {{ page }}</span>
                    {% if work_orders|length >= 25 %}
                    <a href="{{ url_for('work_orders_list', page=page+1, **current_filters) }}" class="btn btn-outline-primary btn-sm">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Work Orders Found</h4>
                {% if current_filters %}
                <p class="text-muted">No work orders match your current filters.</p>
                <a href="{{ url_for('work_orders_list') }}" class="btn btn-primary">
                    <i class="fas fa-times"></i> Clear Filters
                </a>
                {% else %}
                <p class="text-muted">There are no work orders in the database.</p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    
    {% endif %}
</div>

<!-- Work Order Details Modal -->
<div class="modal fade" id="workOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Work Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="workOrderModalBody">
                <!-- Details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function showWorkOrderDetails(woKey) {
    if (!woKey) {
        alert('Work order key not available');
        return;
    }
    
    // Show modal with loading
    const modal = new bootstrap.Modal(document.getElementById('workOrderModal'));
    const modalBody = document.getElementById('workOrderModalBody');
    modalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading...</p></div>';
    modal.show();
    
    // Here you could fetch detailed work order info
    // For now, just show basic info
    modalBody.innerHTML = `
        <div class="alert alert-info">
            <h6>Work Order: ${woKey}</h6>
            <p>Detailed view functionality will be implemented based on your requirements.</p>
        </div>
    `;
}

function editWorkOrder(woKey) {
    if (!woKey) {
        alert('Work order key not available');
        return;
    }
    
    alert(`Edit functionality for Work Order ${woKey} will be implemented based on your requirements.`);
}

// Auto-refresh every 5 minutes
setInterval(function() {
    console.log('Auto-refreshing work orders...');
    // Uncomment to enable auto-refresh
    // window.location.reload();
}, 300000);
</script>

{% endblock %}
